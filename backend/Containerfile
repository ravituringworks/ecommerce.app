# syntax=docker/dockerfile:1

FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# System dependencies for building some Python packages (e.g., bcrypt, cryptography)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libffi-dev \
    libssl-dev \
 && rm -rf /var/lib/apt/lists/*

# Install Python dependencies first for better caching
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . /app

# Create non-root user and data directory for SQLite persistence
RUN groupadd -r app && useradd -r -g app app \
    && mkdir -p /data \
    && chown -R app:app /app /data

# Lightweight entrypoint to init DB (idempotent) and start the API
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

EXPOSE 8000
VOLUME ["/data"]

USER app

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
